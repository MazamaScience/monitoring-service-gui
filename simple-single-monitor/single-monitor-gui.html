<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Monitor Plots</title>

	<!-- CSS -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

	<!-- JavaScript -->	
	<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
	
	
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

	<style type="text/css">
		body {
			display: flex;
			flex-direction: row;
			align-items: stretch;
			background-color: WhiteSmoke;
		}

		h1 {
			font-size: 32px;
			text-align: center;
			margin-bottom: 16px;
		}

		input {
			margin-bottom: 5px;
		}

		img {
			border-radius: 5px;
		}

		#toolbar {
			width: 280px;
			min-width: 280px;
			height: 100vh;
			padding: 0px 20px;
			display: flex;
			flex-direction: column;
			align-items: center;
			background-color: White;
			box-shadow: gray 0px 0px 20px;
			border-bottom-right-radius: 15px;
		}

		#input-section {
			width: 100%;
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		#buttons-section {
			width: 100%;
			display: flex;
			flex-direction: row;
			justify-content: space-around;
		}

		#buttons-section button {
			width: 90px;
		}

		#nonbutton-section {
			display: flex;
			flex-direction: column;
			width: 100%;
		}

		label {
			font-weight: bold;
			margin-bottom: 2px;
		}

		label.form-check-label {
			font-weight: normal;
		}

		.text-input {
			display: flex;
			flex-direction: column;
		}

		#plot-view {
			flex-grow: 1;
			height: 100vh;
			padding: 40px 40px;
			position: relative;
		}

		#plot-container {
			height: 100%;
			margin: auto;
			position: relative;
		}

		#plot-image {
			max-height: 100%;
			margin: auto;
			box-shadow: 0px 0px 10px gray;
		}

		#loading-spinner {
			position: absolute;
			left: 50%;
			top: 50%;
			width: 100px;
			height: 100px;
			transform-origin: 0% 0%;
			border: 12px solid WhiteSmoke;
			border-top: 12px solid #007bff;
			border-radius: 50%;
			animation: spin 0.45s linear infinite;
			-webkit-animation: spin 0.45s linear infinite; /* Safari */
		}
		
		#error-box {
		  	width: 80%;
		  	min-width: 200px;
			margin: auto;
			padding: 15px;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			border: 1px solid Red;
			border-radius: 5px;
			background-color: #ffe3e3;
			font-family: monospace;
		}
		
		#error-box h1 {
		  font-size: 22px;
		  color: Red;
		}
		
		#error-box p {
		  margin: 0px;
		}

		#instructions-section {
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		#instructions-details {
			padding-right: 15px;		}

		#instructions-section h1 {
			font-size: 1.5rem;
		}

		#instructions-section ol {
			font-size: 0.8rem;
		}

		#instructions-section p {
			font-size: 0.7rem;
		}

		.visible {
			display: block;
		}

		.invisible {
			display: none;
		}

		/* Small devices (landscape phones, less than 768px) */
		@media (max-width: 769px) {
			body {
				flex-direction: column;
			}

			#toolbar {
				width: 100vw;
				height: auto;
				margin-bottom: 10px;
				padding: 0px 15px;
				border-bottom-left-radius: 15px;
			}

			#input-section {
				width: auto;
			}

			#nonbutton-section {
				margin: auto;
				flex-direction: row;
				justify-content: center;
			}

			#plot-type-list {
				margin-right: 30px;
			}

			#instructions-section ol {
				font-size: 0.8rem;
			}

			#instructions-section p {
				text-align: center;
				font-size: 0.7rem;
			}

			#plot-view {
				height: auto;
				padding: 20px 20px;
			}

			#plot-image {
				width: 100%;
			}
		}

		@keyframes spin {
			0% { transform: rotate(0deg) translate(-50%, -50%); }
			100% { transform: rotate(360deg) translate(-50%, -50%); }
		}

		/* Safari */
		@-webkit-keyframes spin {
			0% { -webkit-transform: rotate(0deg) translate(-50%, -50%); }
			100% { -webkit-transform: rotate(360deg) translate(-50%, -50%); }
		}
	</style>
</head>

<body>
	<div id="toolbar" class="pb-1">
		<!-- page title -->
		<div>
			<h1>Single-Monitor Plots</h1>
		</div>

			<!-- Input widgets -->
  		<div id="input-section" class="mb-3">
  			<div id="nonbutton-section">
  				<!-- Plot type input -->
	  			<div id="plot-type-list" class="form-group mb-3">
	  				<label>Plot type</label>

					<div class="form-check">
						<input class="form-check-input" type="radio" name="plot-type" value="dailybarplot" checked>
						<label class="form-check-label">Daily average</label>
					</div>

					<div class="form-check">
						<input class="form-check-input" type="radio" name="plot-type" value="dailybyhour">
						<label class="form-check-label">Time of day</label>
					</div>

					<div class="form-check">
						<input class="form-check-input" type="radio" name="plot-type" value="timeseries">
						<label class="form-check-label">Time series</label>
					</div>
	  			</div>
	  
	  			<!-- Text inputs -->
	  			<div class="mb-2">
	  				<!-- Monitor ID input -->
		  			<div class="form-group text-input">
		  				<label>Monitor ID</label>
		  				<input id="monitorId" type="text" class="form-control input-sm" name="monitorId" size="2">
		  			</div>
		  
		  			<!-- Time range input -->
		  			<div class="form-group text-input">
		  				<label>Date range</label>
		  				<input id="daterange" type="text" class="form-control" name="daterange" value=""/>
		  			</div>
	  			</div>
  			</div>

  			<div id="buttons-section">
	  			<button class="btn btn-secondary" type="button" data-toggle="collapse" data-target="#instructions-details">
					How-to
				</button>

				<button id="generate-button" class="btn btn-success" type="button">
					GO
				</button>
	  		</div>
  		</div>
	
		<div id="instructions-section">
			<div id="instructions-details" class="collapse">
				<ol>
			  	    <li>Select which type of plot you would like to generate.</li>
			  	    <li>Type in the ID of the monitor you would like to inspect. You can find a monitor's ID by clicking on its icon in <a href="https://tools.airfire.org/monitoring" target="_blank">this map</a> and scrolling down to the "Selected Monitors" list at the bottom of the page.</li>
			  	    <li>Select the date range by clicking on the date widget. You can type  in the start and end dates or select a start and end day in the calendar popup.</li>
			  	</ol>
			  	  
			  	<p>Changing any of the fields will automatically generate a plot. The image itself may take a few seconds to load.</p>
			</div>
		</div>
	</div>

	<div id="plot-view">
		<div id="plot-container">
			<img id="plot-image" src="" class="invisible">
			<div id="loading-spinner" class="invisible"></div>
			<div id="error-box" class="invisible">
			  <h1>ERROR</h1>
			  <p id="error-message"></p>
			</div>
		</div>
	</div>

	<script type="text/javascript">
		//const plotServicePath = "https://tools.airfire.org/monitor-plot/v4/"; // Production
	  	//const plotServicePath = "https://test.airfire.org/monitor-plot/test/"; // Test 
	  	//const plotServicePath = "http://localhost:8080/monitor-plot/dev/"; // RStudio test
	  	//const plotServicePath = "http://localhost:8080/monitor-plot/test/" // Local Docker test
	  	const plotServicePath = "https://test-c1.airfire.org/monitor-plot/test/";
	  	const plotServiceName = "plot";
	
		$(function() {
			/**
		   	 * Open the date input field as a DateRangerPicker widget, and set the 
		   	 * initial date range to the last 10 days.
		   	 */
			$("input[name=daterange]").daterangepicker({
				startDate: moment().subtract(10, "day").startOf("day").toDate(),
        		endDate: moment().startOf("day").toDate(),
				opens: "left"
			}, function(start, end, label) {});

			$("#generate-button").click(function() {
				hideErrorBox();

				// Check if the input monitor ID matches the correct format.
			  	// If so, continue generating the plot.
			  	// Otherwise, inform the user with an error message.
				const monitorIdRegex = /^[0-9]+_[0-9]*$/;
			 	const monitorId = $("#monitorId").val();

			  	if (monitorIdRegex.test(monitorId)) {
			    	updatePlot();
			  	} else {
			    	const errorMessage = "The input monitor ID: '" + monitorId + "' is not in the format 'aqsID_instrumentID'\nExample: '010890014_01'";
			    	showErrorBox(errorMessage);
			  	}
			});

			/**
			 * React when the plot image loads.
			 */
			document.getElementById("plot-image").onload = function() {
				// Hide loading spinner
				$("#loading-spinner").removeClass("visible");
				$("#loading-spinner").addClass("invisible");

				// Show plot image
				$("#plot-image").removeClass("invisible");
				$("#plot-image").addClass("visible");
			}
			
			// Show error box
			function showErrorBox(errorMessage) {
			  	// Set error box text
		    	$("#error-message").text(errorMessage);
		    
				$("#error-box").removeClass("invisible");
				$("#error-box").addClass("visible");
				
				// Hide loading spinner
				$("#loading-spinner").removeClass("visible");
				$("#loading-spinner").addClass("invisible");
			}
			
			// Hide the error box
			function hideErrorBox() {
			  $("#error-box").removeClass("visible");
				$("#error-box").addClass("invisible");
			}
			
			/**
			 * Builds a plot request and sets the plot image to the resulting URL. 
			 */
			function updatePlot() {
			  const plotRequestURL = buildPlotRequestURL();
			  
			  console.log(plotRequestURL);
			  
			  if (plotRequestURL != null) {
			    updatePlotSource(plotRequestURL);
			  }
			}

	      	/**
	         * Builds a request to the plot service API using form input.
	         */
			function buildPlotRequestURL() {
				// Get form input
				const plotType  = $("input[name=plot-type]:checked").val();
				const monitorId = $("#monitorId").val();
				const dateRange = $("input[name=daterange]").val().split(" - ");

				// Convert format of input date range
				const startDate = moment(dateRange[0], "MM/DD/YYYY").format('YYYYMMDD'); 
				const endDate   = moment(dateRange[1], "MM/DD/YYYY").format('YYYYMMDD');
				
				// Build plot request queriy string
				const queryParams = 
				  "databaseversion=4.0" +
				  "&webserviceapi=4.0" + 
					"&plottype="  + plotType +
					"&monitorid=" + monitorId +
					"&startdate=" + startDate +
					"&enddate="   + endDate;

				// Build plot image request URL
				const plotRequestURL = plotServicePath + plotServiceName + "?" + queryParams;
				
				// Build plot json request URL
        		const jsonRequestURL = plotRequestURL + "&responsetype=json";
        
		        // Request the JSON response first to check for server-side errors
		        fetch(jsonRequestURL, { mode: 'cors' })
					.then(response => response.json())
					.then(data => {
					  console.log(data);
					  if (data.status == "error") {
					  	handleServerError(data.errors);
					  	return null;
					  }
					})
					.catch(error => {
						return null;
					});
				
				return plotRequestURL;
			}

			/**
			 * Handles server side errors by displaying them in an error message box. Some common errors are translated to more user-friendly text.
			 * @param error  the error message string from the server
			 */
			function handleServerError(serverErrorString) {
				// Define regex test patterns for common errors
				const nonexistantMonitorIDPattern = /^Error : Error in createDataList\(infoList, DATA_DIR\) : ↵  Error loading data: Error in monitor_subset\(ws_monitor1, monitorIDs = monitorID\) : ↵  ws_monitor object contains zero monitors↵$/;

				// Collapse all line breaks in the server error string with a "↵" character
				const stringifiedError = serverErrorString.replace(/(\r\n|\n|\r)/gm, "↵");
				console.log(stringifiedError);

				// Default error box message if the server error doesn't match an existing test pattern
				let errorBoxMessage = serverErrorString;

				// Test if the server error matches a pattern, and generate the corresponding error box message
				if (nonexistantMonitorIDPattern.test(stringifiedError)) {
					const monitorId = $("#monitorId").val();
					errorBoxMessage = "Could not find monitor with ID: '" + monitorId + "'";
				} else if (invalidDateRangePattern.test(stringifiedError)) {
					errorBoxMessage = "Weewoo";
				}

				console.log(serverErrorString);

				showErrorBox(errorBoxMessage);
			}
			
			/**
			 * Sets the plot image's source URL and hides the plot and shows the 
			 * loading spinner.
			 */
			function updatePlotSource(plotRequestURL) {
			  // Update plot image source
				$("#plot-image").attr("src", plotRequestURL);
				
				// Hide plot image
				$("#plot-image").removeClass("visible");
				$("#plot-image").addClass("invisible");

				// Show loading spinner
				$("#loading-spinner").removeClass("invisible");
				$("#loading-spinner").addClass("visible");
			}
		});
	</script>
</body>
</html>
